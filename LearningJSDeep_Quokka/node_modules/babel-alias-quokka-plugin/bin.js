"use strict";

var _findBabelConfig = require("find-babel-config");

var _findBabelConfig2 = _interopRequireDefault(_findBabelConfig);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _module2 = require("module");

var _babelPluginModuleResolver = require("babel-plugin-module-resolver");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const root = _path2.default.resolve(".");

const loadLikeNormal = _module2.Module._load;

exports.before = config => {
  const moduleResolverOpts = getModuleResolverOpts(config);
  _module2.Module._load = (requireString, _module, isMain) => {
    const normalPath = (0, _babelPluginModuleResolver.resolvePath)(requireString, _module.filename, moduleResolverOpts) || requireString;
    return loadLikeNormal(normalPath, _module, isMain);
  };
};

const getModuleResolverOpts = ({ alias } = {}) => {
  if (alias) return { root, alias };
  let babelConfig = _findBabelConfig2.default.sync(root).config;
  if (babelConfig.env) {
    babelConfig = babelConfig.env[process.env.BABEL_ENV || process.env.NODE_ENV || "development"];
  }
  if (!babelConfig || !babelConfig.plugins) return null;
  const moduleResolverConfig = babelConfig.plugins.find(pluginConfig => pluginConfig[0] === "module-resolver");
  return moduleResolverConfig && moduleResolverConfig[1];
};
